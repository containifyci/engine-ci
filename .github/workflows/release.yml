name: Release

on:
  push:
    branches:
      - main

concurrency:
  # Grouped by ref (branch/tag name) not to cancel other jobs running for other feature branches
  group: engine_ci_service_${{ github.ref }}
  # > cancel any currently running job or workflow in the same concurrency group
  # in case of multiple pushes to the same branch, we just need the latest, so cancel all previous
  cancel-in-progress: true

permissions:
  contents: write # for checkout
  id-token: write # for authenticating to Google Cloud Platform
  pull-requests: write # for updating pr

jobs:
  sub-module-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Get Next Version
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ github.token }}
          branch: main
          noVersionBumpBehavior: silent
          skipInvalidTags: true
          maxTagsToFetch: 50
      - name: Update major and minor release tags
        uses: containifyci/.github/github-actions/update-semver@main
        with:
          tag_name: client/${{ steps.semver.outputs.next }}
          prefix: client/v
        env:
          GITHUB_TOKEN: ${{ secrets.CONTAINIFYCI_RELEASE_TOKEN  }}
      - name: Update major and minor release tags
        uses: containifyci/.github/github-actions/update-semver@main
        with:
          tag_name: protos2/${{ steps.semver.outputs.next }}
          prefix: protos2/v
        env:
          GITHUB_TOKEN: ${{ secrets.CONTAINIFYCI_RELEASE_TOKEN  }}
  build-engine-ci:
    needs: sub-module-release
    uses: ./.github/workflows/engine-ci.yml
    secrets: inherit
  release-engine-ci:
    runs-on: ubuntu-latest
    needs: build-engine-ci
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Get Next Version
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ github.token }}
          branch: main
          noVersionBumpBehavior: silent
          skipInvalidTags: true
          maxTagsToFetch: 50
      - name: Create Release
        uses: ncipollo/release-action@v1
        if: steps.semver.outputs.next
        with:
          allowUpdates: true
          # draft: true
          generateReleaseNotes: true
          makeLatest: true
          tag: ${{ steps.semver.outputs.next }}
          token: ${{ secrets.CONTAINIFYCI_RELEASE_TOKEN }}
